<!DOCTYPE html>
<html>
<head>
  <title>Mind Map Visualization Test</title>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { margin: 0; font-family: Arial, sans-serif; }
    #graph { width: 100vw; height: 100vh; background: #f8f9fa; }
    .node-circle { stroke: #fff; stroke-width: 2px; cursor: pointer; }
    .type-Metric { fill: #3b82f6; }
    .type-Date { fill: #10b981; }
    .type-Person { fill: #8b5cf6; }
    .type-Project { fill: #f59e0b; }
    .type-Topic { fill: #ec4899; }
    .link-line { stroke: #94a3b8; stroke-opacity: 0.6; }
    .link-label { fill: #64748b; font-size: 10px; pointer-events: none; }
    .node-label { fill: #1e293b; font-size: 12px; font-weight: 600; pointer-events: none; text-anchor: middle; }
  </style>
</head>
<body>
  <svg id="graph"></svg>
  
  <script>
    const API_BASE = window.location.origin;
    const svg = d3.select('#graph');
    const width = window.innerWidth;
    const height = window.innerHeight;
    
    svg.attr('width', width).attr('height', height);
    
    // Load ontology data
    fetch(`${API_BASE}/doc/doc_business_plan/ontology`)
      .then(r => r.json())
      .then(ontology => {
        console.log('Ontology loaded:', ontology);
        drawMindMap(ontology);
      })
      .catch(err => {
        console.error('Error:', err);
        svg.append('text')
          .attr('x', width / 2)
          .attr('y', height / 2)
          .attr('text-anchor', 'middle')
          .text('Error loading ontology: ' + err.message);
      });
    
    function drawMindMap(ontology) {
      const concepts = ontology.concepts;
      const relations = ontology.relations.map(r => ({
        ...r,
        source: r.src_concept_id,
        target: r.dst_concept_id
      }));
      
      console.log('Drawing', concepts.length, 'concepts and', relations.length, 'relations');
      
      // Create force simulation
      const simulation = d3.forceSimulation(concepts)
        .force('charge', d3.forceManyBody().strength(-800))
        .force('center', d3.forceCenter(width / 2, height / 2))
        .force('collision', d3.forceCollide().radius(60))
        .force('link', d3.forceLink(relations)
          .id(d => d.id)
          .distance(150)
          .strength(0.5));
      
      // Draw links
      const links = svg.append('g')
        .selectAll('line')
        .data(relations)
        .join('line')
        .attr('class', 'link-line')
        .attr('stroke-width', d => 1 + d.confidence * 3);
      
      // Draw link labels
      const linkLabels = svg.append('g')
        .selectAll('text')
        .data(relations)
        .join('text')
        .attr('class', 'link-label')
        .text(d => d.rel);
      
      // Draw nodes
      const nodes = svg.append('g')
        .selectAll('g')
        .data(concepts)
        .join('g')
        .attr('class', 'node')
        .call(d3.drag()
          .on('start', dragStarted)
          .on('drag', dragged)
          .on('end', dragEnded));
      
      // Node circles
      nodes.append('circle')
        .attr('class', d => `node-circle type-${d.type}`)
        .attr('r', d => 12 + d.confidence * 8)
        .on('click', (event, d) => {
          console.log('Clicked:', d);
        });
      
      // Node labels
      nodes.append('text')
        .attr('class', 'node-label')
        .attr('dy', 30)
        .text(d => d.label);
      
      // Update positions on tick
      simulation.on('tick', () => {
        links
          .attr('x1', d => d.source.x)
          .attr('y1', d => d.source.y)
          .attr('x2', d => d.target.x)
          .attr('y2', d => d.target.y);
        
        linkLabels
          .attr('x', d => (d.source.x + d.target.x) / 2)
          .attr('y', d => (d.source.y + d.target.y) / 2);
        
        nodes.attr('transform', d => `translate(${d.x},${d.y})`);
      });
      
      // Drag functions
      function dragStarted(event, d) {
        if (!event.active) simulation.alphaTarget(0.3).restart();
        d.fx = d.x;
        d.fy = d.y;
      }
      
      function dragged(event, d) {
        d.fx = event.x;
        d.fy = event.y;
      }
      
      function dragEnded(event, d) {
        if (!event.active) simulation.alphaTarget(0);
        d.fx = null;
        d.fy = null;
      }
    }
  </script>
</body>
</html>

