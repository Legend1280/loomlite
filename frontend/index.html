<!DOCTYPE html>
<!-- v2.0.1 - Upload fix deployment -->
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Loom Lite - Semantic Knowledge Navigator</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #0a0a0a;
      color: #e5e5e5;
      overflow: hidden;
      height: 100vh;
      font-size: 13px;
    }
    
    /* TOOLBAR */
    #toolbar {
      height: 56px;
      background: #0c0c0c;
      border-bottom: 1px solid rgba(42, 42, 42, 0.4);
      padding: 0 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 24px;
    }
    
    /* VIEW MODE BUTTONS */
    #viewModeButtons {
      flex: 1;
      display: flex;
      gap: 24px;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
    }
    
    .view-mode-btn {
      padding: 8px;
      background: transparent;
      border: none;
      border-radius: 6px;
      color: #e6e6e6;
      cursor: pointer;
      transition: all 0.15s cubic-bezier(0.25, 0.1, 0.25, 1);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .view-mode-btn:hover {
      background: rgba(250, 214, 67, 0.2);
      color: #fad643;
    }
    
    .view-mode-btn.active {
      color: #fad643;
      filter: drop-shadow(0 0 4px rgba(250, 214, 67, 0.3));
    }
    
    .view-mode-btn svg {
      display: block;
      stroke-width: 2;
    }
    
    /* UPLOAD BUTTON */
    .upload-btn {
      padding: 8px 16px;
      background: transparent;
      border: 1px solid #fad643;
      border-radius: 6px;
      color: #fad643;
      font-size: 12px;
      font-weight: 500;
      font-family: 'Inter', sans-serif;
      letter-spacing: 0.5px;
      cursor: pointer;
      transition: all 0.15s cubic-bezier(0.25, 0.1, 0.25, 1);
    }
    
    .upload-btn:hover {
      background: rgba(250, 214, 67, 0.1);
    }
    
    .upload-btn:active {
      background: #fad643;
      color: #0c0c0c;
    }
    
    /* THREE-PANEL LAYOUT */
    #app {
      display: flex;
      height: calc(100vh - 60px);
    }
    
    /* LEFT SIDEBAR */
    #sidebar {
      width: 16rem;
      background: #181818;
      border-right: 1px solid rgba(42, 42, 42, 0.5);
      overflow-y: auto;
      flex-shrink: 0;
    }
    
    #sidebar.collapsed {
      width: 3.5rem;
    }
    
    /* CENTER PANEL - DUAL VISUALIZER */
    #center {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0;
      padding: 8px;
      background: #0a0a0a;
      min-width: 0;
    }
    
    .visualizer-container {
      flex: 1;
      background: #181818;
      border: 1px solid rgba(42, 42, 42, 0.5);
      border-radius: 8px;
      overflow: hidden;
      position: relative;
      min-height: 0;
    }
    
    /* RESIZABLE DIVIDERS */
    .resize-handle {
      background: rgba(42, 42, 42, 0.5);
      position: relative;
      z-index: 100;
      transition: all 0.15s cubic-bezier(0.25, 0.1, 0.25, 1);
    }
    
    .resize-handle:hover {
      background: rgba(250, 214, 67, 0.1);
    }
    
    .resize-handle-horizontal {
      height: 8px;
      cursor: ns-resize;
      margin: 0;
    }
    
    .resize-handle-vertical {
      width: 8px;
      cursor: ew-resize;
      flex-shrink: 0;
    }
    
    .resize-handle-horizontal::before,
    .resize-handle-vertical::before {
      content: '';
      position: absolute;
      background: #2a2a2a;
      border-radius: 2px;
    }
    
    .resize-handle-horizontal::before {
      width: 40px;
      height: 3px;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }
    
    .resize-handle-vertical::before {
      width: 3px;
      height: 40px;
      left: 50%;
      top: 50%;
      transform: translate(-50%, -50%);
    }
    
    .visualizer-label {
      position: absolute;
      top: 12px;
      left: 12px;
      font-size: 11px;
      text-transform: uppercase;
      color: #9b9b9b;
      font-weight: 500;
      z-index: 10;
      pointer-events: none;
    }
    
    .visualizer-container svg {
      width: 100%;
      height: 100%;
    }
    
    /* VIEW MODE CLASSES */
    #app.split-mode #visualizer-top,
    #app.split-mode #visualizer-bottom {
      display: flex;
    }
    
    #app.solar-only #visualizer-top {
      flex: 1;
    }
    
    #app.solar-only #visualizer-bottom {
      display: none;
    }
    
    #app.mind-only #visualizer-top {
      display: none;
    }
    
    #app.mind-only #visualizer-bottom {
      flex: 1;
    }
    
    /* RIGHT PANEL - SURFACE VIEWER */
    #surface-viewer {
      width: 28rem;
      background: #181818;
      border-left: 1px solid rgba(42, 42, 42, 0.5);
      overflow-y: auto;
      flex-shrink: 0;
    }
    
    /* RESPONSIVE */
    @media (max-width: 1200px) {
      #surface-viewer {
        width: 20rem;
      }
    }
    
    @media (max-width: 900px) {
      #app {
        flex-direction: column;
      }
      
      #sidebar,
      #surface-viewer {
        width: 100%;
        height: auto;
      }
    }
    
    /* SYSTEM STATUS DASHBOARD */    #systemStatus {
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: #181818;
      border: 1px solid rgba(42, 42, 42, 0.5);
      border-radius: 8px;
      padding: 0;
      min-width: 250px;
      max-width: 300px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.5);
      z-index: 9999;
    }  font-size: 12px;
    }
    
    .status-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 12px;
      background: #111111;
      border-bottom: 1px solid rgba(42, 42, 42, 0.5);
      border-radius: 8px 8px 0 0;
      cursor: move;
    }
    
    .status-title {
      font-weight: 500;
      color: #e6e6e6;
      font-size: 12px;
      letter-spacing: 0.5px;
    }
    
    .status-toggle {
      background: none;
      border: none;
      color: #9a9a9a;
      font-size: 18px;
      cursor: pointer;
      padding: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 4px;
      transition: all 0.15s cubic-bezier(0.25, 0.1, 0.25, 1);
    }
    
    .status-toggle:hover {
      background: rgba(250, 214, 67, 0.1);
      color: #fad643;
    }
    
    .status-content {
      padding: 12px;
      max-height: 400px;
      overflow-y: auto;
    }
    
    .status-section {
      margin-bottom: 12px;
    }
    
    .status-section:last-child {
      margin-bottom: 0;
    }
    
    .status-section-title {
      font-size: 11px;
      font-weight: 500;
      color: #9a9a9a;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }
    
    .status-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 4px 0;
      transition: opacity 0.2s;
    }
    
    .status-icon {
      font-size: 14px;
      width: 18px;
      text-align: center;
    }
    
    .status-label {
      flex: 1;
      color: #e6e6e6;
      font-size: 11px;
    }
    
    .status-value {
      color: #fad643;
      font-weight: 500;
      font-size: 11px;
    }
    
    /* Glowing threads (static, no animation for performance) */
    .thread {
      /* No animation - just static glow via SVG filter */
    }
  </style>
</head>
<body>
  <!-- TOOLBAR -->
  <div id="toolbar">
    <!-- Logo -->
    <img src="logo.png" alt="Loom Lite" style="height: 32px; width: 32px; border-radius: 50%;">
    
    <!-- View Mode Icons -->
    <div id="viewModeButtons">
      <button class="view-mode-btn active" data-mode="galaxy" title="Galaxy View">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
          <circle cx="8" cy="8" r="1.5" fill="currentColor"/>
          <circle cx="4" cy="4" r="1"/>
          <circle cx="12" cy="5" r="1"/>
          <circle cx="11" cy="11" r="1"/>
          <path d="M 6 6 Q 8 8 10 6" stroke-linecap="round"/>
        </svg>
      </button>
      <button class="view-mode-btn" data-mode="solar" title="Solar System View">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
          <circle cx="8" cy="8" r="2" fill="currentColor"/>
          <circle cx="8" cy="8" r="5"/>
          <circle cx="8" cy="8" r="7"/>
        </svg>
      </button>
      <button class="view-mode-btn" data-mode="split" title="Split View">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
          <rect x="2" y="2" width="5" height="12" rx="1"/>
          <rect x="9" y="2" width="5" height="12" rx="1"/>
        </svg>
      </button>
      <button class="view-mode-btn" data-mode="mind" title="Mind Map View">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none" stroke="currentColor" stroke-width="1.5">
          <circle cx="8" cy="8" r="2" fill="currentColor"/>
          <circle cx="3" cy="4" r="1.5"/>
          <circle cx="13" cy="4" r="1.5"/>
          <circle cx="8" cy="13" r="1.5"/>
          <line x1="6.5" y1="7" x2="4" y2="5"/>
          <line x1="9.5" y1="7" x2="12" y2="5"/>
          <line x1="8" y1="10" x2="8" y2="11.5"/>
        </svg>
      </button>
    </div>
    
    <!-- Upload Button -->
    <button class="upload-btn">UPLOAD</button>
  </div>
  
  <!-- THREE-PANEL LAYOUT -->
  <div id="app" class="split-mode">
    <!-- LEFT SIDEBAR -->
    <aside id="sidebar"></aside>
    
    <!-- RESIZE HANDLE (Sidebar | Center) -->
    <div class="resize-handle resize-handle-vertical" id="resize-sidebar"></div>
    
    <!-- CENTER PANEL - MULTI-LEVEL VISUALIZER -->
    <main id="center">
      <!-- Galaxy View (Level 1: All Documents) -->
      <div id="galaxyContainer" class="visualizer-container" style="display: block;">
        <div class="visualizer-label">GALAXY VIEW - All Documents</div>
      </div>
      
      <!-- Solar System View (Level 2: One Document) -->
      <div id="visualizer-top" class="visualizer-container" style="display: none;">
        <div class="visualizer-label">SOLAR SYSTEM VIEW</div>
        <svg></svg>
      </div>
      
      <!-- RESIZE HANDLE (Solar | Mind Map) -->
      <div class="resize-handle resize-handle-horizontal" id="resize-center" style="display: none;"></div>
      
      <!-- Mind Map View (Hierarchical) -->
      <div id="visualizer-bottom" class="visualizer-container" style="display: none;">
        <div class="visualizer-label">MIND MAP</div>
        <svg></svg>
      </div>
    </main>
    
    <!-- RESIZE HANDLE (Center | Surface) -->
    <div class="resize-handle resize-handle-vertical" id="resize-surface"></div>
    
    <!-- RIGHT PANEL - SURFACE VIEWER -->
    <aside id="surface-viewer"></aside>
  </div>
  
  <!-- LOAD MODULES -->
  <script type="module">
    // Import event bus first (required by other modules)
    import { bus, setCurrentDocId } from './eventBus.js';
    
    // Import core modules
    import { initGalaxyView } from './galaxyView.js';
    import { drawDualVisualizer } from './dualVisualizer.js';
    import { initPlanetView } from './planetView.js';
    import { initFileSystemSidebar } from './navigator.js';
    import { initSurfaceViewer } from './surfaceViewer.js';
    import { initSearchBar } from './searchBar.js';
    import { initSystemStatus } from './systemStatus.js';
    import { initQuadrantFocus } from './quadrantFocus.js';
    
    /**
     * Initialize resizable panels with drag handles
     */
    function initResizablePanels() {
      // Sidebar resize
      const resizeSidebar = document.getElementById('resize-sidebar');
      const sidebar = document.getElementById('sidebar');
      
      if (resizeSidebar && sidebar) {
        let isResizing = false;
        
        resizeSidebar.addEventListener('mousedown', (e) => {
          isResizing = true;
          document.body.style.cursor = 'ew-resize';
          document.body.style.userSelect = 'none';
        });
        
        document.addEventListener('mousemove', (e) => {
          if (!isResizing) return;
          
          const newWidth = e.clientX;
          if (newWidth >= 200 && newWidth <= 400) {
            sidebar.style.width = `${newWidth}px`;
          }
        });
        
        document.addEventListener('mouseup', () => {
          if (isResizing) {
            isResizing = false;
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
          }
        });
      }
      
      // Surface viewer resize
      const resizeSurface = document.getElementById('resize-surface');
      const surfaceViewer = document.getElementById('surface-viewer');
      
      if (resizeSurface && surfaceViewer) {
        let isResizing = false;
        
        resizeSurface.addEventListener('mousedown', (e) => {
          isResizing = true;
          document.body.style.cursor = 'ew-resize';
          document.body.style.userSelect = 'none';
        });
        
        document.addEventListener('mousemove', (e) => {
          if (!isResizing) return;
          
          const newWidth = window.innerWidth - e.clientX;
          if (newWidth >= 300 && newWidth <= 800) {
            surfaceViewer.style.width = `${newWidth}px`;
          }
        });
        
        document.addEventListener('mouseup', () => {
          if (isResizing) {
            isResizing = false;
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
          }
        });
      }
      
      // Center panel resize (Solar | Mind Map)
      const resizeCenter = document.getElementById('resize-center');
      const visualizerTop = document.getElementById('visualizer-top');
      const visualizerBottom = document.getElementById('visualizer-bottom');
      
      if (resizeCenter && visualizerTop && visualizerBottom) {
        let isResizing = false;
        let startY = 0;
        let startTopHeight = 0;
        let startBottomHeight = 0;
        
        resizeCenter.addEventListener('mousedown', (e) => {
          isResizing = true;
          startY = e.clientY;
          startTopHeight = visualizerTop.offsetHeight;
          startBottomHeight = visualizerBottom.offsetHeight;
          document.body.style.cursor = 'ns-resize';
          document.body.style.userSelect = 'none';
        });
        
        document.addEventListener('mousemove', (e) => {
          if (!isResizing) return;
          
          const delta = e.clientY - startY;
          const newTopHeight = startTopHeight + delta;
          const newBottomHeight = startBottomHeight - delta;
          
          if (newTopHeight >= 200 && newBottomHeight >= 200) {
            visualizerTop.style.flex = 'none';
            visualizerTop.style.height = `${newTopHeight}px`;
            visualizerBottom.style.flex = 'none';
            visualizerBottom.style.height = `${newBottomHeight}px`;
          }
        });
        
        document.addEventListener('mouseup', () => {
          if (isResizing) {
            isResizing = false;
            document.body.style.cursor = '';
            document.body.style.userSelect = '';
          }
        });
      }
      
      console.log('Resizable panels initialized');
    }
    
    // Initialize app
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('Loom Lite v2.0 Core - Initializing...');
      
      // Initialize modules
      console.log('Initializing modules...');
      try {
        // Create file system sidebar container
        const sidebarEl = document.getElementById('sidebar');
        if (sidebarEl) {
          sidebarEl.id = 'file-system-sidebar';
        }
        initFileSystemSidebar();
        console.log('File System Sidebar initialized');
      } catch (e) {
        console.error('File System Sidebar init failed:', e);
      }
      
      try {
        initSurfaceViewer();
        console.log('Surface Viewer initialized');
      } catch (e) {
        console.error('Surface Viewer init failed:', e);
      }
      
      try {
        initSearchBar();
        console.log('Search Bar initialized');
      } catch (e) {
        console.error('Search Bar init failed:', e);
      }
      
      // Initialize Upload button
      const uploadBtn = document.querySelector('.upload-btn');
      if (uploadBtn) {
        uploadBtn.addEventListener('click', () => {
          // Create file input if it doesn't exist
          let fileInput = document.getElementById('fileInput');
          if (!fileInput) {
            fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.id = 'fileInput';
            fileInput.multiple = true;  // Enable multiple file selection
            fileInput.accept = '.txt,.md,.pdf,.docx';
            fileInput.style.display = 'none';
            document.body.appendChild(fileInput);
            
            fileInput.addEventListener('change', async (event) => {
              const files = event.target.files;
              if (!files || files.length === 0) {
                console.log('No files selected');
                return;
              }
              
              console.log(`${files.length} file(s) selected`);
              const startTime = Date.now();
              let successCount = 0;
              let failCount = 0;
              
              // Upload each file sequentially
              for (let i = 0; i < files.length; i++) {
                const file = files[i];
                console.log(`→ Uploading ${i+1}/${files.length}: ${file.name} (${(file.size/1024).toFixed(1)} KB)`);
                
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                  const response = await fetch('https://loomlite-production.up.railway.app/api/ingest/file', {
                    method: 'POST',
                    body: formData
                  });
                  
                  if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                  }
                  
                  const result = await response.json();
                  console.log(`Uploaded ${file.name}: ${result.job_id}`);
                  successCount++;
                } catch (error) {
                  console.error(`Failed ${file.name}:`, error);
                  failCount++;
                }
              }
              
              const elapsed = ((Date.now() - startTime) / 1000).toFixed(1);
              console.log(`\nUpload Summary:`);
              console.log(`   Success: ${successCount}`);
              console.log(`   Failed: ${failCount}`);
              console.log(`   Time: ${elapsed}s`);
              
              // Show summary alert
              if (failCount === 0) {
                alert(`Successfully uploaded ${successCount} file(s) in ${elapsed}s!\n\nRefreshing page...`);
              } else {
                alert(`Upload completed with errors:\nSuccess: ${successCount}\nFailed: ${failCount}\n\nCheck console for details.`);
              }
              
              // Refresh document list
              if (successCount > 0) {
                setTimeout(() => location.reload(), 1000);
              }
              
              // Reset file input for next upload
              fileInput.value = '';
            });
          }
          
          console.log('Opening file picker...');
          fileInput.click();
        });
        console.log('Upload button initialized (multi-file support)');
      }
      
      // Set up view mode buttons
      const viewModeButtons = document.querySelectorAll('.view-mode-btn');
      const app = document.getElementById('app');
      const galaxyContainer = document.getElementById('galaxyContainer');
      const solarContainer = document.getElementById('visualizer-top');
      const mindContainer = document.getElementById('visualizer-bottom');
      
      viewModeButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          const mode = btn.dataset.mode;
          
          // Update active state
          viewModeButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          
          // Get resize handle
          const resizeCenter = document.getElementById('resize-center');
          
          // Show/hide appropriate containers
          if (mode === 'galaxy') {
            galaxyContainer.style.display = 'block';
            solarContainer.style.display = 'none';
            mindContainer.style.display = 'none';
            if (resizeCenter) resizeCenter.style.display = 'none';
          } else if (mode === 'solar') {
            galaxyContainer.style.display = 'none';
            solarContainer.style.display = 'block';
            mindContainer.style.display = 'none';
            if (resizeCenter) resizeCenter.style.display = 'none';
          } else if (mode === 'split') {
            galaxyContainer.style.display = 'none';
            solarContainer.style.display = 'block';
            mindContainer.style.display = 'block';
            if (resizeCenter) resizeCenter.style.display = 'block';
            
            // Initialize mind map for current document
            const currentDoc = window.getCurrentDocId ? window.getCurrentDocId() : null;
            if (currentDoc) {
              initPlanetView(currentDoc).catch(e => console.error('Planet view init failed:', e));
            }
          } else if (mode === 'mind') {
            galaxyContainer.style.display = 'none';
            solarContainer.style.display = 'none';
            mindContainer.style.display = 'block';
            if (resizeCenter) resizeCenter.style.display = 'none';
            
            // Initialize mind map for current document
            const currentDoc = window.getCurrentDocId ? window.getCurrentDocId() : null;
            if (currentDoc) {
              initPlanetView(currentDoc).catch(e => console.error('Planet view init failed:', e));
            }
          }
          
          // Update app class
          app.className = mode;
          
          console.log(`View mode changed to: ${mode}`);
        });
      });
      
      // Initialize Galaxy View (default view)
      try {
        await initGalaxyView();
        console.log('Galaxy View initialized');
      } catch (error) {
        console.error('Galaxy View init failed:', error);
      }
      
      // Listen for view mode change events (programmatic)
      bus.on('viewModeChanged', (event) => {
        const { mode } = event.detail;
        console.log(`Programmatic view mode change to: ${mode}`);
        
        // Trigger the button click to switch mode
        const btn = document.querySelector(`[data-mode="${mode}"]`);
        if (btn) {
          btn.click();
        }
      });
      
      // Listen for document focus events
      bus.on('documentFocus', async (event) => {
        const { docId } = event.detail;
        console.log(`📝 Loading document: ${docId}`);
        
        // Store current doc ID globally
        window.getCurrentDocId = () => docId;
        
        // Load the solar system visualization
        await drawDualVisualizer(docId);
        
        // Also load mind map if in split mode
        const currentMode = document.querySelector('.view-mode-btn.active')?.dataset.mode;
        if (currentMode === 'split') {
          await initPlanetView(docId);
        }
        
        // Load document in Surface Viewer (Document Mode by default)
        // The surfaceViewer will handle this via its own event listener
      });
      
      // Initialize Resizable Panels
      initResizablePanels();
      
      // Initialize Quadrant Focus System
      try {
        initQuadrantFocus();
        console.log('Quadrant Focus system initialized');
      } catch (e) {
        console.error('Quadrant Focus init failed:', e);
      }
      
      // Initialize System Status Dashboard
      try {
        initSystemStatus();
        console.log('System Status Dashboard initialized');
      } catch (e) {
        console.error('System Status init failed:', e);
      }
      
      console.log('Loom Lite v2.0 Core - Ready');
    });
  </script>
</body>
</html>

